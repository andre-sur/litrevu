{% extends 'base.html' %}

{% block content %}
  <!-- Lien Ajouter un ticket -->
  <div style="margin-bottom: 20px;">
    <a href="{% url 'create_ticket' %}" class="btn-ticket">Ajouter un ticket</a>
  </div>

  <h2>Tickets suivis par l'utilisateur</h2>

  <!-- Menu d√©roulant pour choisir l'ordre d'affichage -->
  <form method="get">
    <label for="order">Trier par :</label>
    <select name="order" id="order" onchange="this.form.submit()">
      <option value="date" {% if request.GET.order == "date" or not request.GET.order %}selected{% endif %}>Date (plus r√©cents en premier)</option>
      <option value="user" {% if request.GET.order == "user" %}selected{% endif %}>Nom d'utilisateur (ordre alphab√©tique)</option>
    </select>
  </form>
  <br>

  <div class="ticket-list">
    {% for ticket in page_obj %}
      <div class="ticket">
        <h3>
          {{ ticket.title }}
          <small>({{ ticket.user.username }} ‚Äì {{ ticket.time_created|date:"d/m/Y H:i" }})</small>
        </h3>

        {% if ticket.image %}
          <div class="ticket-image">
            <img src="{{ ticket.image.url }}" alt="Image du ticket" style="max-width: 200px; max-height: 150px; object-fit: cover;">
          </div>
        {% endif %}

        <div class="ticket-description-box">
          <p class="ticket-description">{{ ticket.description }}</p>
        </div>

        <!-- üîò Boutons associ√©s au ticket -->
        <div class="ticket-buttons" style="margin: 10px 0;">
          <!-- Bouton "Ajouter une review" toujours visible -->
          <form action="{% url 'add_review' ticket.id %}" method="get" style="display: inline;">
            <button type="submit" class="button">Ajouter une review</button>
          </form>

          {% if ticket.user == request.user %}
            <!-- Ces boutons sont r√©serv√©s au cr√©ateur du ticket -->
            <form action="{% url 'edit_ticket' ticket.id %}" method="get" style="display: inline;">
              <button type="submit" class="button">Modifier ce ticket</button>
            </form>

            <form action="{% url 'confirm_delete_ticket' ticket.id %}" method="get" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="button">Supprimer ce ticket</button>
            </form>
          {% endif %}
        </div>

        <!-- Affichage des reviews -->
        <div class="reviews">
          {% for review in ticket.review_set.all %}
            <div class="review small-text">
              <hr class="review-separator">
              <p><strong>{{ review.headline }} ({{ review.user.username }})</strong></p>

              <div class="review-description-box">
                {{ review.body }}
              </div>

              <p><strong>Note :</strong> {{ review.rating }} / 5</p>
              <p><strong>Publi√© le :</strong> {{ review.time_created }}</p>

              <div class="review-buttons">
                {% if review.user == request.user %}
                  <form action="{% url 'edit_review' review.id %}" method="get" style="display: inline;">
                    <button type="submit" class="button">Modifier</button>
                  </form>
                  <form action="{% url 'confirm_delete_review' review.id %}" method="get" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="button">Effacer</button>
                  </form>
                {% endif %}
              </div>
            </div>
          {% empty %}
            <p>Aucune review pour ce ticket.</p>
          {% endfor %}
        </div>
      </div>
    {% empty %}
      <p>Aucun ticket suivi.</p>
    {% endfor %}
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <span class="step-links">
      {% if page_obj.has_previous %}
        <a href="?page=1">&laquo; Premi√®re</a>
        <a href="?page={{ page_obj.previous_page_number }}">Pr√©c√©dente</a>
      {% endif %}
      <span class="current">
        Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}.
      </span>
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">Suivante</a>
        <a href="?page={{ page_obj.paginator.num_pages }}">Derni√®re &raquo;</a>
      {% endif %}
    </span>
  </div>
{% endblock %}
