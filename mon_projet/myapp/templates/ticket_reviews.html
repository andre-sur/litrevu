{% extends 'base.html' %}

{% block content %}
    <h2>Choisir un ticket et voir les reviews</h2>

    <!-- Formulaire pour sélectionner un propriétaire -->
    <form method="POST" id="ticket-form">
        {% csrf_token %}
        <label for="owner">Choisir un propriétaire:</label>
        <select name="owner" id="owner" onchange="this.form.submit()">
            {% for user in users %}
                <option value="{{ user.id }}" {% if user.id == selected_owner.id %}selected{% endif %}>{{ user.username }}</option>
            {% endfor %}
        </select>
    </form>

    {% if selected_owner %}
        <!-- Formulaire pour sélectionner un ticket de l'utilisateur sélectionné -->
        <form method="POST">
            {% csrf_token %}
            <label for="ticket">Choisir un ticket:</label>
            <select name="ticket" id="ticket" onchange="this.form.submit()">
                {% for ticket in tickets %}
                    <option value="{{ ticket.id }}" {% if ticket.id == selected_ticket.id %}selected{% endif %}>{{ ticket.title }}</option>
                {% empty %}
                    <option disabled>Aucun ticket disponible pour cet utilisateur.</option>
                {% endfor %}
            </select>
            <button type="submit" class="button">Valider</button>
        </form>
    {% endif %}

    {% if selected_ticket %}
        <h3>Reviews pour le ticket "{{ selected_ticket.title }}"</h3>

        <div class="reviews">
            {% for review in reviews %}
                <div class="review">
                    <p><strong>{{ review.headline }}</strong></p>

                    <!-- Bouton pour afficher/masquer les détails -->
                    <button class="button toggle-details" data-review-id="{{ review.id }}">Voir les détails</button>

                    <!-- Bouton "Modifier" seulement si l'utilisateur est celui qui a créé le ticket -->
                    {% if review.user == request.user %}
                        <a href="{% url 'edit_review' review.id %}" class="button">Modifier</a>
                    {% endif %}

                    <!-- Détails cachés par défaut -->
                    <div id="details-{{ review.id }}" class="review-details" style="display:none;">
                        <p><strong>Description:</strong> {{ review.body }}</p>
                        <p><strong>Note:</strong> {{ review.rating }} / 5</p>
                        <p><strong>Publié le :</strong> {{ review.time_created }}</p>
                    </div>
                </div>
            {% empty %}
                <p>Aucune review pour ce ticket.</p>
            {% endfor %}
        </div>

        <!-- Bouton pour ajouter une review -->
        <a href="{% url 'add_review' selected_ticket.id %}" class="button">Ajouter une review</a>

    {% endif %}
{% endblock %}
